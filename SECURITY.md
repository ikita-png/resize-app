# 🔒 セキュリティガイド

画像リサイズツールのセキュリティ機能に関する完全ガイドです。

---

## 📊 セキュリティ概要

| 評価項目 | スコア |
|---------|:------:|
| 認証 | 95% |
| 通信 | 95% |
| サーバー保護 | 95% |
| データ保護 | 90% |
| **総合** | **94%** |

---

## 🔐 実装済みセキュリティ機能

### 1. パスワード認証システム

アプリへのアクセスをパスワードで保護します。

#### 設定方法

`.env` ファイルに以下を追加：

```env
ACCESS_PASSWORD=your_strong_password_here
```

#### 技術仕様

| 項目 | 内容 |
|------|------|
| Cookie名 | `resize_auth` |
| 認証方式 | Base64エンコード + タイムスタンプ |
| 有効期間 | 24時間（セッションタイムアウトと連動） |

#### 動作フロー

```
ユーザーがアクセス
      ↓
ACCESS_PASSWORD が設定されている？
├── いいえ → そのままアクセス可能
└── はい → ログイン画面表示
          ↓
    パスワード入力
    ├── 正しい → Cookie発行 → アプリ利用可
    └── 間違い → エラー表示
```

---

### 2. ログイン試行回数制限

ブルートフォース攻撃（パスワード総当たり）を防止します。

#### 設定値

`server/security.ts` で変更可能：

```typescript
login: {
  maxAttempts: 5,                      // 最大試行回数
  lockoutDurationMs: 15 * 60 * 1000,   // ロック時間（15分）
  attemptWindowMs: 15 * 60 * 1000,     // 試行カウント期間（15分）
}
```

#### 動作例

| 試行回数 | 表示メッセージ |
|:--------:|---------------|
| 1回失敗 | 「パスワードが正しくありません（残り4回）」 |
| 2回失敗 | 「パスワードが正しくありません（残り3回）」 |
| 3回失敗 | 「パスワードが正しくありません（残り2回）」 |
| 4回失敗 | 「パスワードが正しくありません（残り1回）」 |
| 5回失敗 | 「ログインが15分間ロックされました」 |

#### 技術仕様

| 項目 | 内容 |
|------|------|
| 識別方法 | IPアドレス単位 |
| 記録場所 | サーバーメモリ（Map） |
| 自動クリーンアップ | 1時間ごと |

#### 防御対象

- ✅ パスワード総当たり攻撃（ブルートフォース）
- ✅ 辞書攻撃
- ✅ 自動化されたログイン試行

---

### 3. ユーザー別処理回数制限

1人のユーザーによる過剰な処理を制限し、リソースを保護します。

#### 設定値

`server/security.ts` で変更可能：

```typescript
processing: {
  maxPerDay: 100,    // 1日あたり：最大100枚
  maxPerHour: 30,    // 1時間あたり：最大30枚
}
```

#### 動作例

| 状況 | 動作 |
|------|------|
| 1時間で30枚未満 | 処理続行 |
| 1時間で30枚以上 | エラー「1時間あたりの処理上限に達しました」 |
| 1日で100枚未満 | 処理続行 |
| 1日で100枚以上 | エラー「1日あたりの処理上限に達しました」 |

#### 技術仕様

| 項目 | 内容 |
|------|------|
| 識別方法 | セッションCookie |
| 記録場所 | サーバーメモリ（Map） |
| リセットタイミング | 時間：毎時 / 日次：0時頃 |
| 自動クリーンアップ | 2日以上前のデータは削除 |

#### 防御対象

- ✅ 1人による大量処理（コスト爆発防止）
- ✅ API悪用
- ✅ サービス独占

---

### 4. セッションタイムアウト

一定時間操作がないと自動的にログアウトされます。

#### 設定値

`server/security.ts` で変更可能：

```typescript
session: {
  timeoutMs: 24 * 60 * 60 * 1000,  // 24時間
}
```

#### 動作フロー

```
ログイン成功 → セッション開始
      ↓
ユーザーが操作 → 最終アクティビティ時刻を更新
      ↓
24時間操作なし → セッション無効化
      ↓
次回アクセス時 → 再ログインが必要
```

#### 技術仕様

| 項目 | 内容 |
|------|------|
| 追跡対象 | 全APIリクエスト |
| 記録場所 | サーバーメモリ（Map） |
| Cookie有効期限 | 24時間 |

#### 防御対象

- ✅ 放置されたセッションからの不正アクセス
- ✅ 共有PCでのセッション乗っ取り
- ✅ 古いセッションの悪用

---

### 5. HTTPSリダイレクト & セキュリティヘッダー

本番環境で通信を暗号化し、各種攻撃を防ぎます。

#### 実装場所

`server/_core/index.ts`

#### セキュリティヘッダー一覧

| ヘッダー | 値 | 防御対象 |
|---------|-----|---------|
| `Strict-Transport-Security` | `max-age=31536000; includeSubDomains` | HTTP通信傍受、中間者攻撃 |
| `X-Content-Type-Options` | `nosniff` | MIMEタイプ偽装攻撃 |
| `X-Frame-Options` | `DENY` | クリックジャッキング |
| `X-XSS-Protection` | `1; mode=block` | XSS攻撃 |
| `Referrer-Policy` | `strict-origin-when-cross-origin` | リファラー情報漏洩 |

#### HTTPSリダイレクト

本番環境（`NODE_ENV=production`）では、HTTP接続を自動的にHTTPSへリダイレクトします。

```
http://example.com → 301リダイレクト → https://example.com
```

---

### 6. キューシステム（DoS対策）

APIへの同時リクエスト数を制限し、サーバー過負荷を防ぎます。

#### 設定値

`server/queue.ts` で変更可能：

```typescript
const DEFAULT_CONFIG = {
  maxConcurrent: 2,            // 同時処理数
  maxQueueSize: 50,            // 最大待機数
  jobTimeout: 5 * 60 * 1000,   // タイムアウト（5分）
  retryAttempts: 3,            // リトライ回数
  retryDelay: 3000,            // リトライ間隔（3秒）
};
```

#### 動作フロー

```
リクエストA → 処理中（1/2）
リクエストB → 処理中（2/2）
リクエストC → 待機列に追加（位置: 1）
リクエストD → 待機列に追加（位置: 2）
   ︙
リクエストA完了 → リクエストCを処理開始
```

#### 防御対象

- ✅ DoS攻撃（サービス妨害）
- ✅ fal.ai APIレート制限違反
- ✅ サーバーリソース枯渇

---

### 7. 入力検証（Zodスキーマ）

すべてのAPIリクエストのパラメータを厳密に検証します。

#### 検証内容

```typescript
z.object({
  imageUrls: z.array(z.string()).min(1).max(14),  // 画像URL：1〜14枚
  aspectRatio: aspectRatioSchema,                  // アスペクト比：規定値のみ
  resolution: z.enum(["1K", "2K", "4K"]),         // 解像度：規定値のみ
  outputFormat: z.enum(["jpeg", "png", "webp"]),  // 形式：規定値のみ
  numImages: z.number().min(1).max(4),            // 枚数：1〜4
})
```

#### 防御対象

- ✅ SQLインジェクション
- ✅ 不正なパラメータ
- ✅ バッファオーバーフロー

---

### 8. 環境変数による機密情報管理

APIキー・パスワードをコードに埋め込まず、環境変数で管理します。

#### 管理対象

| 変数名 | 用途 |
|--------|------|
| `FAL_KEY` | fal.ai APIキー |
| `ACCESS_PASSWORD` | アクセスパスワード |
| `JWT_SECRET` | セッション暗号化キー |

#### セキュリティ対策

- ✅ `.gitignore`で`.env`をGit管理対象外に設定
- ✅ 本番環境では環境変数を直接設定
- ✅ コードレビューで機密情報が漏れない

---

## 🛡️ 攻撃別 防御マッピング

| 攻撃種別 | 防御機能 | 設定ファイル |
|---------|---------|-------------|
| ブルートフォース攻撃 | ログイン試行制限（5回） | `security.ts` |
| DoS/DDoS攻撃 | キューシステム、処理回数制限 | `queue.ts`, `security.ts` |
| セッション乗っ取り | セッションタイムアウト（24時間） | `security.ts` |
| 中間者攻撃 | HTTPS強制、HSTS | `index.ts` |
| XSS攻撃 | X-XSS-Protection、入力検証 | `index.ts`, `routers.ts` |
| クリックジャッキング | X-Frame-Options | `index.ts` |
| APIキー漏洩 | 環境変数管理、.gitignore | `.env` |
| リソース悪用 | ユーザー別処理制限 | `security.ts` |

---

## ⚙️ 設定カスタマイズガイド

### パスワードの変更

`.env` ファイルを編集：

```env
ACCESS_PASSWORD=新しいパスワード
```

> ⚠️ 16文字以上、英数字・記号混在を推奨

### ログイン試行制限の変更

`server/security.ts` の `SECURITY_CONFIG` を編集：

```typescript
login: {
  maxAttempts: 10,                     // 試行回数を10回に増加
  lockoutDurationMs: 30 * 60 * 1000,   // ロック時間を30分に変更
}
```

### 処理回数制限の変更

```typescript
processing: {
  maxPerDay: 200,    // 1日200枚に増加
  maxPerHour: 50,    // 1時間50枚に増加
}
```

### セッションタイムアウトの変更

```typescript
session: {
  timeoutMs: 8 * 60 * 60 * 1000,  // 8時間に変更
}
```

---

## 📋 セキュリティチェックリスト

### デプロイ前の確認

- [ ] `ACCESS_PASSWORD` を強力なパスワードに設定
- [ ] `JWT_SECRET` をランダムな文字列に設定
- [ ] `FAL_KEY` を正しく設定
- [ ] `.env` が `.gitignore` に含まれていることを確認
- [ ] 本番環境でHTTPSが有効であることを確認

### 運用時の確認

- [ ] 定期的にパスワードを変更
- [ ] ログを監視して不審なアクセスをチェック
- [ ] 処理制限値が適切か定期的に見直し

---

## 📁 関連ファイル一覧

| ファイル | 役割 |
|----------|------|
| `server/security.ts` | セキュリティ機能本体 |
| `server/queue.ts` | キューシステム |
| `server/routers.ts` | API入力検証、認証エンドポイント |
| `server/_core/index.ts` | セキュリティヘッダー、HTTPSリダイレクト |
| `server/_core/env.ts` | 環境変数管理 |
| `server/_core/cookies.ts` | Cookie設定 |
| `client/src/pages/Login.tsx` | ログイン画面 |
| `client/src/App.tsx` | 認証ラッパー |
| `.env` | 機密情報設定 |
| `.env.example` | 設定サンプル |

---

## 🔄 更新履歴

| 日付 | 内容 |
|------|------|
| 2026-01-16 | 初版作成 |
| 2026-01-16 | ログイン試行制限を追加 |
| 2026-01-16 | ユーザー別処理制限を追加 |
| 2026-01-16 | セッションタイムアウトを追加 |

---

## 📞 サポート

セキュリティに関する問題を発見した場合は、管理者にご連絡ください。
